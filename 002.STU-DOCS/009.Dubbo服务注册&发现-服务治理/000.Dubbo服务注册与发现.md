# Dubbo服务注册与发现
> 先阅读:[Dubbo服务注册与发现-000.mp4](./000.LESSONS/000.Dubbo服务发现与注册/Load-balancing-strategy-and-configuration-details-000.mp4)、[Dubbo服务注册与发现-001.mp4](./000.LESSONS/000.Dubbo服务发现与注册/Load-balancing-strategy-and-configuration-details-001.mp4)、[Dubbo服务注册与发现-002.mp4](./000.LESSONS/000.Dubbo服务发现与注册/Load-balancing-strategy-and-configuration-details-002.mp4) 、 [Dubbo3 应用级服务发现设计.png
](./cn.dubbo.apache.org_zh-cn_overview_reference_proposals_service-discovery_.png)

### Dubbo2 服务注册与发现
```java
public interface DemoSentinelService {

    String sayHello(String name);

    default CompletableFuture<String> sayHelloAsync(String name) {
        return CompletableFuture.completedFuture(sayHello(name));
    }
}

## Dubbo2 URL地址格式，也是注册时的Key
06:35:20.158 |-INFO  [main]    org.apache.dubbo.config.ServiceConfig:932 -|  [DUBBO] Register dubbo service org.apache.dubbo.demo.DemoSentinelService url dubbo://192.168.3.7:20880/org.apache.dubbo.demo.DemoSentinelService?anyhost=true&application=dubbo-demo-sentinel-provider&background=false&bind.ip=192.168.3.7&bind.port=20880&deprecated=false&dubbo=2.0.2&dynamic=true&executes=9&executor-management-mode=isolation&file-cache=true&generic=false&interface=org.apache.dubbo.demo.DemoSentinelService&methods=sayHello,sayHelloAsync&pid=65192&prefer.serialization=hessian2,fastjson2&service-name-mapping=true&side=provider&timestamp=1739745319877 to registry 192.168.3.198:2181, dubbo version: , current host: 192.168.3.7

```

##### Dubbo2问题 <sup>数据放大，见[Dubbo3 应用级服务发现设计.png](./cn.dubbo.apache.org_zh-cn_overview_reference_proposals_service-discovery_.png)</sup>
- 注册中心集群容量达到上限阈值
- Consumer 常驻内存占用高 ， 每次服务调用都会带来CPU等资源消耗，影响正常服务调用。

---

### Dubbo3 服务注册与发现
将注册Key提升至应用级，即只保留 ip ， port , 但在Dubbo3中，服务粒度还是接口级别的，那么如何Dubbo3如何还原成Dubbo2的接口级URL地址格式呢? 那就是： MetadataService
> 由 Consumer 向 Provider 点对点拉取，最终在运行态还原出类似 Dubbo2 的 URL 地址格式

Dubbo3服务发现流程:
1. provider 向 注册中心注册服务（精简后的地址： ip , port）
2. Dubbo3 consumer 从注册中心拉取精简后的服务地址
3. Dubbo3 consumer 通过 MetadataService 向Provider 拉取RPC元数据，最终在运行态还原出类似 Dubbo2 的 URL 地址格式.

##### 一些关键日志
###### Consumer刷新元数据日志
```log
getServiceMetadata():283, DefaultServiceInstance (org.apache.dubbo.registry.client), DefaultServiceInstance.java
getExportedServicesRevision(ServiceInstance):132, ServiceInstanceMetadataUtils (org.apache.dubbo.registry.client.metadata), ServiceInstanceMetadataUtils.java
calOrUpdateInstanceRevision(ServiceInstance):372, AbstractServiceDiscovery (org.apache.dubbo.registry.client), AbstractServiceDiscovery.java
update():191, AbstractServiceDiscovery (org.apache.dubbo.registry.client), AbstractServiceDiscovery.java
2 hidden frames
refreshMetadataAndInstance(ApplicationModel):239, ServiceInstanceMetadataUtils (org.apache.dubbo.registry.client.metadata), ServiceInstanceMetadataUtils.java
lambda$registerServiceInstance$5():1033, DefaultApplicationDeployer (org.apache.dubbo.config.deploy), DefaultApplicationDeployer.java
4 hidden frames
 - Async stack trace
3 hidden frames
registerServiceInstance:1010, DefaultApplicationDeployer (org.apache.dubbo.config.deploy)
prepareApplicationInstance:795, DefaultApplicationDeployer (org.apache.dubbo.config.deploy)
checkState:1188, DefaultApplicationDeployer (org.apache.dubbo.config.deploy)
notifyModuleChanged:1176, DefaultApplicationDeployer (org.apache.dubbo.config.deploy)
onModuleStarted:373, DefaultModuleDeployer (org.apache.dubbo.config.deploy)
startSync:191, DefaultModuleDeployer (org.apache.dubbo.config.deploy)
start:159, DefaultModuleDeployer (org.apache.dubbo.config.deploy)
startModules:771, DefaultApplicationDeployer (org.apache.dubbo.config.deploy)
doStart:735, DefaultApplicationDeployer (org.apache.dubbo.config.deploy)
start:708, DefaultApplicationDeployer (org.apache.dubbo.config.deploy)
start:230, DubboBootstrap (org.apache.dubbo.config.bootstrap)
start:219, DubboBootstrap (org.apache.dubbo.config.bootstrap)
startWithBootstrap:53, Application (org.apache.dubbo.sentinel.provider)
main:34, Application (org.apache.dubbo.sentinel.provider)
```